import React, { useState } from "react";

// NurseCarePlus - single-file React component
// TailwindCSS utility classes assumed available in the project
// Uses simple rule-based "AI" engine for diagnosis suggestions (replaceable by real AI API)

export default function NurseCarePlus() {
  const [tab, setTab] = useState("home");
  const [patient, setPatient] = useState({
    name: "",
    age: "",
    sex: "",
    diagnosis: "",
    contact: "",
  });

  const initialAssessment = {
    bp: "",
    hr: "",
    rr: "",
    temp: "",
    o2: "",
    subjective: "",
    objective: "",
    location: "",
    onset: "",
    character: "",
    intensity: "",
    duration: "",
    aggravating: "",
    alleviating: "",
    associated: "",
    prevTreatment: "",
    prevTreatmentResult: "",
    ob_lmp: "",
    ob_edc: "",
  };

  const [assessment, setAssessment] = useState(initialAssessment);
  const [diagnoses, setDiagnoses] = useState([]);
  const [references, setReferences] = useState([
    { title: "World Health Organization (WHO)", url: "https://www.who.int" },
    { title: "PubMed (NIH)", url: "https://pubmed.ncbi.nlm.nih.gov" },
    { title: "Philippine DOH", url: "https://doh.gov.ph" },
  ]);

  // Simple rule-based diagnosis generator. Replace this function with an AI call to OpenAI or other model
  function generateDiagnosesFromAssessment(a) {
    const results = [];
    const temp = parseFloat(a.temp);
    const rr = parseInt(a.rr);
    const hr = parseInt(a.hr);
    const o2 = parseFloat(a.o2);

    // Risk checks
    if (!isNaN(o2) && o2 < 92) {
      results.push({
        code: "RESP-HYPOXIA",
        title: "Hypoxemia / Impaired Gas Exchange",
        reasons: [
          `Oxygen saturation ${o2}% on room air (low)`,
          "Tachypnea or accessory muscle use noted",
        ],
        carePlan: [
          "Administer supplemental oxygen as ordered to maintain SpO2 ≥ 94% (or target per MD).",
          "Raise head of bed to semi-Fowler's position to ease breathing.",
          "Continuous pulse oximetry until stable.",
        ],
        vitalsSchedule: "Monitor SpO2 and RR every 15–30 minutes until stable, then hourly.",
        teaching: [
          "Explain oxygen therapy purpose to patient/guardian.",
          "Advise on deep-breathing exercises and positioning to improve oxygenation.",
        ],
      });
    }

    if (!isNaN(temp) && temp >= 38) {
      results.push({
        code: "INF-FEVER",
        title: "Fever (Possible Infectious Process)",
        reasons: [`Temperature ${temp}°C`],
        carePlan: [
          "Ensure adequate hydration and ambient cooling measures.",
          "Administer antipyretics per order (e.g., acetaminophen) and re-check temperature in 30–60 minutes.",
        ],
        vitalsSchedule: "Check temperature every 1–2 hours until afebrile or stable.",
        teaching: ["Explain fever management and when to seek urgent care (difficulty breathing, seizures)."],
      });
    }

    // Pneumonia suggestion rules
    const productiveCough = /sputum|productive|yellow|green|thick/i.test(a.subjective + " " + a.objective);
    const chestCrackles = /crackles|rales|wheeze|bronchial/i.test(a.objective);
    if ((productiveCough || chestCrackles) && (rr >= 20 || temp >= 38 || o2 < 95)) {
      const severity = o2 < 90 || rr >= 30 || hr >= 120 ? "Severe" : "Moderate";
      results.push({
        code: "RESP-PNEUMONIA",
        title: `Pneumonia (${severity} severity) — likely lower respiratory tract infection`,
        reasons: [
          productiveCough ? "Productive cough noted" : null,
          chestCrackles ? "Crackles on lung auscultation" : null,
          !isNaN(rr) ? `RR ${rr} breaths/min` : null,
          !isNaN(temp) ? `Temp ${temp}°C` : null,
          !isNaN(o2) ? `SpO2 ${o2}%` : null,
        ].filter(Boolean),
        carePlan: [
          "Collect sputum sample if ordered and send for gram stain/culture as indicated.",
          "Administer antibiotics as prescribed by physician (give first dose promptly).",
          "Provide oxygen therapy if SpO2 < 94% and per orders.",
          "Encourage coughing and deep breathing, provide chest physiotherapy if available.",
          "Monitor intake/output and maintain hydration.",
        ],
        vitalsSchedule: o2 < 92 ? "Continuous SpO2 monitoring; vitals q15–30min" : "Vitals q4h or as ordered",
        teaching: [
          "Finish full course of antibiotics and return if breathing worsens.",
          "Signs of worsening: increased work of breathing, cyanosis, persistent high fever — seek urgent care.",
        ],
      });
    }

    // Dehydration / poor intake
    const lowIntake = /decreased appetite|no appetite|reduced intake|vomit|unable to eat/i.test(a.subjective);
    if (lowIntake) {
      results.push({
        code: "FLUID-DEFICIT",
        title: "Risk for Deficient Fluid Volume",
        reasons: ["Decreased oral intake reported", "Fever increases insensible losses"],
        carePlan: ["Encourage small, frequent sips; consider IV fluids per order if oral intake insufficient"],
        vitalsSchedule: "I&O and vitals q4h; check for weight changes and skin turgor.",
        teaching: ["Offer favorite fluids, explain importance of hydration when febrile."],
      });
    }

    if (results.length === 0) {
      results.push({
        code: "OBS",
        title: "Observation / Routine Care",
        reasons: ["No clear rule-based triggers met; continue monitoring and document changes."],
        carePlan: ["Monitor vitals per facility protocol; re-assess if symptoms change."],
        vitalsSchedule: "Vitals q4–8h or per facility protocol.",
        teaching: ["Keep patient comfortable and report changes immediately."],
      });
    }

    return results;
  }

  function handleGenerate(e) {
    e.preventDefault();
    const generated = generateDiagnosesFromAssessment(assessment);
    // Add patient/assessment snapshot to each diagnosis
    const timestamp = new Date().toISOString();
    const enriched = generated.map((d) => ({ ...d, patient: { ...patient }, assessment: { ...assessment }, createdAt: timestamp }));
    setDiagnoses((prev) => [...enriched, ...prev]);
    setTab("diagnoses");
  }

  function downloadJSON() {
    const payload = { patient, assessment, diagnoses };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
    const dlAnchor = document.createElement("a");
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download", `${patient.name || "patient"}_nursecare_export.json`);
    document.body.appendChild(dlAnchor);
    dlAnchor.click();
    dlAnchor.remove();
  }

  function resetForm() {
    setPatient({ name: "", age: "", sex: "", diagnosis: "", contact: "" });
    setAssessment(initialAssessment);
  }

  return (
    <div className="min-h-screen bg-gray-50 p-6 text-gray-800">
      <header className="max-w-6xl mx-auto mb-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">NurseCare+ — Nursing Care Plan Assistant</h1>
            <p className="text-sm text-gray-600">Create assessments, generate nursing diagnoses, and build care plans — single-file demo app</p>
          </div>
          <div className="text-right">
            <p className="text-sm">Contact: abdulmaliksarip566@gmail.com</p>
            <p className="text-sm">Phone: +63 981 042 0232</p>
          </div>
        </div>
        <nav className="mt-4 flex gap-2">
          {[
            ["home", "Home"],
            ["about", "About"],
            ["assessment", "Health Assessment"],
            ["diagnoses", "Diagnoses"],
            ["resources", "Resources"],
            ["contact", "Contact"],
          ].map(([key, label]) => (
            <button
              key={key}
              onClick={() => setTab(key)}
              className={`px-3 py-1 rounded ${tab === key ? "bg-indigo-600 text-white" : "bg-white border"}`}
            >
              {label}
            </button>
          ))}
        </nav>
      </header>

      <main className="max-w-6xl mx-auto">
        {tab === "home" && (
          <section className="bg-white p-6 rounded shadow">
            <h2 className="text-xl font-semibold mb-2">Welcome</h2>
            <p className="mb-2">This app helps nursing students and clinicians collect health assessments and generate evidence-informed nursing diagnoses and care plans. The content mirrors what you'd place on a nursing portfolio or clinical tool.</p>
            <h3 className="font-medium mt-4">About (also on About tab)</h3>
            <p className="text-sm text-gray-700">Tool created as a single-file React demo. Replace the rule-based engine with an AI API (OpenAI or others) for more advanced suggestions. Use the Resources tab for curated references (WHO, PubMed, DOH).</p>
          </section>
        )}

        {tab === "about" && (
          <section className="bg-white p-6 rounded shadow">
            <h2 className="text-xl font-semibold mb-2">About NurseCare+</h2>
            <p>NurseCare+ is a teaching/demo app that demonstrates how to collect structured assessment data (vital signs, subjective/objective), run a diagnosis engine, and present nursing care plans, vitals schedule, and teaching points. Intended for student practice and portfolio use.</p>
          </section>
        )}

        {tab === "assessment" && (
          <section className="bg-white p-6 rounded shadow">
            <h2 className="text-xl font-semibold mb-4">Health Assessment</h2>
            <form onSubmit={handleGenerate} className="grid gap-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input placeholder="Patient Name" value={patient.name} onChange={(e) => setPatient({ ...patient, name: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Age" value={patient.age} onChange={(e) => setPatient({ ...patient, age: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Sex" value={patient.sex} onChange={(e) => setPatient({ ...patient, sex: e.target.value })} className="p-2 border rounded" />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                <input placeholder="BP (e.g., 120/80 mmHg)" value={assessment.bp} onChange={(e) => setAssessment({ ...assessment, bp: e.target.value })} className="p-2 border rounded" />
                <input placeholder="HR (bpm)" value={assessment.hr} onChange={(e) => setAssessment({ ...assessment, hr: e.target.value })} className="p-2 border rounded" />
                <input placeholder="RR (breaths/min)" value={assessment.rr} onChange={(e) => setAssessment({ ...assessment, rr: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Temp (°C)" value={assessment.temp} onChange={(e) => setAssessment({ ...assessment, temp: e.target.value })} className="p-2 border rounded" />
                <input placeholder="O2 Sat (%)" value={assessment.o2} onChange={(e) => setAssessment({ ...assessment, o2: e.target.value })} className="p-2 border rounded" />
              </div>

              <textarea placeholder="Subjective data (chief complaint, HPI)" value={assessment.subjective} onChange={(e) => setAssessment({ ...assessment, subjective: e.target.value })} className="p-2 border rounded h-24" />
              <textarea placeholder="Objective data (observations, exam findings)" value={assessment.objective} onChange={(e) => setAssessment({ ...assessment, objective: e.target.value })} className="p-2 border rounded h-24" />

              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input placeholder="Location (e.g., lungs - bilateral lower lobes)" value={assessment.location} onChange={(e) => setAssessment({ ...assessment, location: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Onset (e.g., 3 days ago)" value={assessment.onset} onChange={(e) => setAssessment({ ...assessment, onset: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Character (e.g., productive cough)" value={assessment.character} onChange={(e) => setAssessment({ ...assessment, character: e.target.value })} className="p-2 border rounded" />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input placeholder="Intensity (1-10)" value={assessment.intensity} onChange={(e) => setAssessment({ ...assessment, intensity: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Duration" value={assessment.duration} onChange={(e) => setAssessment({ ...assessment, duration: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Aggravation" value={assessment.aggravating} onChange={(e) => setAssessment({ ...assessment, aggravating: e.target.value })} className="p-2 border rounded" />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <input placeholder="Alleviation" value={assessment.alleviating} onChange={(e) => setAssessment({ ...assessment, alleviating: e.target.value })} className="p-2 border rounded" />
                <input placeholder="Associated symptoms" value={assessment.associated} onChange={(e) => setAssessment({ ...assessment, associated: e.target.value })} className="p-2 border rounded" />
              </div>

              <textarea placeholder="Previous treatments (e.g., antibiotics)" value={assessment.prevTreatment} onChange={(e) => setAssessment({ ...assessment, prevTreatment: e.target.value })} className="p-2 border rounded" />
              <input placeholder="Previous treatment results" value={assessment.prevTreatmentResult} onChange={(e) => setAssessment({ ...assessment, prevTreatmentResult: e.target.value })} className="p-2 border rounded" />

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <input placeholder="OB - LMP (YYYY-MM-DD)" value={assessment.ob_lmp} onChange={(e) => setAssessment({ ...assessment, ob_lmp: e.target.value })} className="p-2 border rounded" />
                <input placeholder="OB - EDC (YYYY-MM-DD)" value={assessment.ob_edc} onChange={(e) => setAssessment({ ...assessment, ob_edc: e.target.value })} className="p-2 border rounded" />
              </div>

              <div className="flex gap-2 mt-2">
                <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded">Generate Diagnosis</button>
                <button type="button" onClick={resetForm} className="border px-4 py-2 rounded">Reset</button>
              </div>
            </form>
          </section>
        )}

        {tab === "diagnoses" && (
          <section className="bg-white p-6 rounded shadow">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold">Diagnoses & Care Plans</h2>
              <div className="flex gap-2">
                <button onClick={downloadJSON} className="border px-3 py-1 rounded">Export JSON</button>
                <button onClick={() => { setDiagnoses([]); }} className="border px-3 py-1 rounded">Clear</button>
              </div>
            </div>

            {diagnoses.length === 0 && <p className="text-gray-600">No diagnoses yet. Create an assessment to generate suggestions.</p>}

            <div className="space-y-4">
              {diagnoses.map((d, idx) => (
                <div key={idx} className="border rounded p-3">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="font-bold">{d.title} <span className="text-sm text-gray-500">({d.code})</span></h3>
                      <p className="text-sm text-gray-600">Generated for: <strong>{d.patient.name || "(unnamed)"}</strong> — {new Date(d.createdAt).toLocaleString()}</p>
                    </div>
                    <div className="text-right text-sm">
                      <p>Vitals plan: <strong>{d.vitalsSchedule}</strong></p>
                    </div>
                  </div>

                  <div className="mt-2 grid md:grid-cols-3 gap-3">
                    <div>
                      <h4 className="font-medium">Reasons</h4>
                      <ul className="list-disc ml-5 text-sm">
                        {d.reasons.map((r, i) => <li key={i}>{r}</li>)}
                      </ul>
                    </div>
                    <div>
                      <h4 className="font-medium">Nursing Care / Treatment</h4>
                      <ul className="list-disc ml-5 text-sm">
                        {d.carePlan.map((c, i) => <li key={i}>{c}</li>)}
                      </ul>
                    </div>
                    <div>
                      <h4 className="font-medium">Teaching & Notes</h4>
                      <ul className="list-disc ml-5 text-sm">
                        {d.teaching.map((t, i) => <li key={i}>{t}</li>)}
                      </ul>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {tab === "resources" && (
          <section className="bg-white p-6 rounded shadow">
            <h2 className="text-xl font-semibold mb-2">Resources</h2>
            <p className="mb-3">Curated resources for evidence-based nursing practice. The app can be extended to query these resources or an AI model for citation-backed outputs.</p>
            <ul className="list-disc ml-5">
              {references.map((r, i) => (
                <li key={i}><a className="underline" href={r.url} target="_blank" rel="noreferrer">{r.title}</a></li>
              ))}
            </ul>
            <div className="mt-4">
              <h4 className="font-medium">How to connect to AI / evidence sources</h4>
              <p className="text-sm text-gray-700">To make diagnosis generation AI-powered and citation-backed: set up a server-side function that calls an LLM (OpenAI / Anthropic / Azure) and returns suggested diagnoses plus citations from PubMed/WHO. Never embed secret API keys on the client — use a backend.</p>
            </div>
          </section>
        )}

        {tab === "contact" && (
          <section className="bg-white p-6 rounded shadow">
            <h2 className="text-xl font-semibold mb-2">Contact</h2>
            <p className="mb-2">This demo site belongs to <strong>Abdulmalik Sarip</strong>. Use the contact details below for inquiries or collaborations.</p>
            <ul className="list-disc ml-5">
              <li>Email: <a className="underline" href="mailto:abdulmaliksarip566@gmail.com">abdulmaliksarip566@gmail.com</a></li>
              <li>Phone: <a className="underline" href="tel:+639810420232">+63 981 042 0232</a></li>
            </ul>
          </section>
        )}
      </main>

      <footer className="max-w-6xl mx-auto mt-6 text-center text-sm text-gray-500">
        <p>© NurseCare+ Demo — Use responsibly for educational purposes. Replace the rule-based engine with a secured AI backend for production use.</p>
      </footer>
    </div>
  );
}
